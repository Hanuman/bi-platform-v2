<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans" xmlns:sec="http://www.springframework.org/schema/security"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
                        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-2.0.1.xsd">

  <!-- Bean definitions in this file override bean definitions in repository.spring.xml. -->

  <bean id="aclDataSource" class="org.springframework.jdbc.datasource.DriverManagerDataSource">
    <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
    <property name="url" value="jdbc:hsqldb:mem:test" />
    <property name="username" value="sa" />
    <property name="password" value="" />
  </bean>

  <sec:authentication-provider>
    <sec:user-service id="userDetailsService">
      <sec:user password="password" name="joe" authorities="Authenticated, Admin" />
      <sec:user password="password" name="suzy" authorities="Authenticated" />
    </sec:user-service>
  </sec:authentication-provider>

  <sec:authentication-manager alias="authenticationManager" />

  <bean id="jcrRepository" class="org.springframework.extensions.jcr.jackrabbit.RepositoryFactoryBean">
    <property name="configuration" value="/jackrabbit-test-repo.xml" />
    <property name="homeDir" value="file:/tmp" />
  </bean>

  <bean id="Privilege.JCR_READ" class="org.springframework.beans.factory.config.FieldRetrievingFactoryBean">
    <property name="staticField" value="org.apache.jackrabbit.api.jsr283.security.Privilege.JCR_READ" />
  </bean>
  <bean id="Privilege.JCR_WRITE" class="org.springframework.beans.factory.config.FieldRetrievingFactoryBean">
    <property name="staticField" value="org.apache.jackrabbit.api.jsr283.security.Privilege.JCR_WRITE" />
  </bean>
  <bean id="Privilege.JCR_REMOVE_NODE" class="org.springframework.beans.factory.config.FieldRetrievingFactoryBean">
    <property name="staticField" value="org.apache.jackrabbit.api.jsr283.security.Privilege.JCR_REMOVE_NODE" />
  </bean>
  <bean id="Privilege.JCR_REMOVE_CHILD_NODES" class="org.springframework.beans.factory.config.FieldRetrievingFactoryBean">
    <property name="staticField" value="org.apache.jackrabbit.api.jsr283.security.Privilege.JCR_REMOVE_CHILD_NODES" />
  </bean>
  <bean id="Privilege.JCR_READ_ACCESS_CONTROL" class="org.springframework.beans.factory.config.FieldRetrievingFactoryBean">
    <property name="staticField" value="org.apache.jackrabbit.api.jsr283.security.Privilege.JCR_READ_ACCESS_CONTROL" />
  </bean>
  <bean id="Privilege.JCR_MODIFY_ACCESS_CONTROL" class="org.springframework.beans.factory.config.FieldRetrievingFactoryBean">
    <property name="staticField" value="org.apache.jackrabbit.api.jsr283.security.Privilege.JCR_MODIFY_ACCESS_CONTROL" />
  </bean>
  <bean id="Privilege.JCR_NODE_TYPE_MANAGEMENT" class="org.springframework.beans.factory.config.FieldRetrievingFactoryBean">
    <property name="staticField" value="org.apache.jackrabbit.api.jsr283.security.Privilege.JCR_NODE_TYPE_MANAGEMENT" />
  </bean>
  <bean id="Privilege.JCR_VERSION_MANAGEMENT" class="org.springframework.beans.factory.config.FieldRetrievingFactoryBean">
    <property name="staticField" value="org.apache.jackrabbit.api.jsr283.security.Privilege.JCR_VERSION_MANAGEMENT" />
  </bean>
  <bean id="Privilege.JCR_LOCK_MANAGEMENT" class="org.springframework.beans.factory.config.FieldRetrievingFactoryBean">
    <property name="staticField" value="org.apache.jackrabbit.api.jsr283.security.Privilege.JCR_LOCK_MANAGEMENT" />
  </bean>

  <!-- The authority name granted to the repository admin. -->
  <bean id="executePrivilegeName" class="java.lang.String">
    <constructor-arg value="{http://www.pentaho.org/jcr/1.0}execute" />
  </bean>
  
  <!-- The authority name granted to the repository admin. -->
  <bean id="jackrabbitWritePrivilegeName" class="java.lang.String">
    <constructor-arg value="{internal}write" />
  </bean>

  <bean id="aclService" class="org.pentaho.platform.repository.pcr.jcr.jackrabbit.JackrabbitMutableAclService">
    <constructor-arg ref="jcrTemplate" />
    <constructor-arg ref="commonAuthenticatedAuthorityName" />
    <constructor-arg>
      <bean class="org.springframework.security.acls.domain.ConsoleAuditLogger" />
    </constructor-arg>
    <constructor-arg>
      <map>
        <entry key-ref="RepositoryFilePermission.EXECUTE">
          <list>
            <ref bean="executePrivilegeName" />
          </list>
        </entry>
        <entry key-ref="RepositoryFilePermission.READ">
          <list>
            <ref bean="Privilege.JCR_READ" />
          </list>
        </entry>
        <entry key-ref="RepositoryFilePermission.WRITE">
          <list>
            <!-- JCR_NODE_TYPE_MANAGEMENT is required when creating a node of a specific type -->
            <ref bean="jackrabbitWritePrivilegeName" />
            <ref bean="Privilege.JCR_VERSION_MANAGEMENT" />
            <ref bean="Privilege.JCR_LOCK_MANAGEMENT" />
          </list>
        </entry>
        <entry key-ref="RepositoryFilePermission.DELETE">
          <list>
            <ref bean="Privilege.JCR_REMOVE_NODE" />
          </list>
        </entry>
        <entry key-ref="RepositoryFilePermission.APPEND">
          <list>
            <!-- JCR_NODE_TYPE_MANAGEMENT is required when creating a node of a specific type -->
            <ref bean="jackrabbitWritePrivilegeName" />
            <ref bean="Privilege.JCR_VERSION_MANAGEMENT" />
            <ref bean="Privilege.JCR_LOCK_MANAGEMENT" />
          </list>
        </entry>
        <entry key-ref="RepositoryFilePermission.DELETE_CHILD">
          <list>
            <ref bean="Privilege.JCR_REMOVE_CHILD_NODES" />
          </list>
        </entry>
        <entry key-ref="RepositoryFilePermission.READ_ACL">
          <list>
            <ref bean="Privilege.JCR_READ_ACCESS_CONTROL" />
          </list>
        </entry>
        <entry key-ref="RepositoryFilePermission.WRITE_ACL">
          <list>
            <ref bean="Privilege.JCR_MODIFY_ACCESS_CONTROL" />
          </list>
        </entry>
      </map>
    </constructor-arg>
    <constructor-arg>
      <map>
        <entry key-ref="executePrivilegeName">
          <list>
            <ref bean="RepositoryFilePermission.EXECUTE" />
          </list>
        </entry>
        <entry key-ref="Privilege.JCR_READ">
          <list>
            <ref bean="RepositoryFilePermission.READ" />
          </list>
        </entry>
        <entry key-ref="Privilege.JCR_WRITE">
          <list>
            <ref bean="RepositoryFilePermission.WRITE" />
            <ref bean="RepositoryFilePermission.APPEND" />
          </list>
        </entry>
        <entry key-ref="jackrabbitWritePrivilegeName">
          <list>
            <ref bean="RepositoryFilePermission.WRITE" />
            <ref bean="RepositoryFilePermission.APPEND" />
          </list>
        </entry>
        <entry key-ref="Privilege.JCR_REMOVE_NODE">
          <list>
            <ref bean="RepositoryFilePermission.DELETE" />
          </list>
        </entry>
        <entry key-ref="Privilege.JCR_REMOVE_CHILD_NODES">
          <list>
            <ref bean="RepositoryFilePermission.DELETE_CHILD" />
          </list>
        </entry>
        <entry key-ref="Privilege.JCR_READ_ACCESS_CONTROL">
          <list>
            <ref bean="RepositoryFilePermission.READ_ACL" />
          </list>
        </entry>
        <entry key-ref="Privilege.JCR_MODIFY_ACCESS_CONTROL">
          <list>
            <ref bean="RepositoryFilePermission.WRITE_ACL" />
          </list>
        </entry>
        <entry key-ref="Privilege.JCR_NODE_TYPE_MANAGEMENT">
          <!-- JCR_NODE_TYPE_MANAGEMENT doesn't translate to a RepositoryFilePermission -->
          <list>
          </list>
        </entry>
        <entry key-ref="Privilege.JCR_VERSION_MANAGEMENT">
          <!-- JCR_VERSION_MANAGEMENT doesn't translate to a RepositoryFilePermission -->
          <list>
          </list>
        </entry>
        <entry key-ref="Privilege.JCR_LOCK_MANAGEMENT">
          <!-- JCR_LOCK_MANAGEMENT doesn't translate to a RepositoryFilePermission -->
          <list>
          </list>
        </entry>
      </map>
    </constructor-arg>
  </bean>

</beans>