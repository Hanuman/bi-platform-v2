<project name="bi-platform-dev" basedir="." default="help">
 
  <description>
-------------------------------------------------------------------------------
Development build script for Pentaho BI Server CE.
      
MAIN TARGETS
============
    
  * dev-rebuild: Prepares a clean Tomcat instance with all Pentaho BI Platform 
    dependencies (i.e. JDBC JAR, datasources, supporting WARs, etc), also known
    as a Pentaho-ready Tomcat. This must be called at least once before any 
    call to dev-update.
    
  * dev-update:    
    Copy changed artifacts into Tomcat instance.
   
PREREQUISITES
=============
        
  * Checkout bi-platform-* and mantle projects from 
    svn://source.pentaho.org/svnroot/bi-platform-v2/trunk.
  * Download and unzip Apache Tomcat 5.5 or greater.
  * Download XMLTask, a third-party Ant task. If building from the command
    line, download the JAR and copy into ${user.home}/.ant/lib. If building
    from Eclipse, download the JAR and add it to the classpath of the Ant 
    plugin (Window > Preferences > Ant > Runtime > Classpath).

INSTRUCTIONS
============

  * Create dev_override.properties in the bi-platform-build directory.
  * Add the property tomcat.dir and make the value the absolute path to your 
    unzipped Tomcat installation.
  * Run ant -f dev_build.xml dev-rebuild in the bi-platform-build directory.
  * Eclipse: Create a new server using the Server view. Be sure to set Eclipse 
    to "takeover Tomcat installation." Add source paths and any additional
    arguments to server launch configuration. Optionally configure 
    start-hypersonic and stop-hypersonic scripts under External Tools. Start
    HSQLDB and then start the server.
-------------------------------------------------------------------------------
  </description>

  <property file="dev_override.properties" />
  <property file="dev_build.properties" />

  <fail message="You do not have XMLTask installed. Please install.">
    <condition>
      <not>
        <available classname="com.oopsconsultancy.xmltask.ant.XmlTask" />
      </not>
    </condition>
  </fail>

  <taskdef name="xmltask" classname="com.oopsconsultancy.xmltask.ant.XmlTask" />

  <!-- Properties with Default Values -->
  <property name="tomcat.lib.dir" value="${tomcat.dir}/common/lib" />
  <property name="stage.dir" value="../tomcat-pci-test" />
  <property name="target.tomcat.dir" value="${stage.dir}/biserver-ce/tomcat" />
  <property name="classes.dir" value="${target.tomcat.dir}/webapps/pentaho/WEB-INF/classes" />
  <property name="web-inf.lib.dir" value="${target.tomcat.dir}/webapps/pentaho/WEB-INF/lib" />
  <property name="source-solution" value="../bi-platform-sample-solution" />
  <property name="target-solution" value="${stage.dir}/biserver-ce/pentaho-solutions" />
  <property name="jre.dir" value="../dummy-jre" />
  <property name="suppress-svn-validation" value="true" />

  <path id="classpath">
    <!-- classes dir is both a destination for .class files and a source for dependencies -->
    <pathelement location="${classes.dir}" />
    <!-- WEB-INF/lib contains non-bi-platform-* dependencies (populated by dev_rebuild) -->
    <fileset dir="${web-inf.lib.dir}">
      <include name="*.jar" />
    </fileset>
    <!-- need this for servlet.jar -->
    <fileset dir="${tomcat.lib.dir}">
      <include name="*.jar" />
    </fileset>
  </path>

  <target name="dev-rebuild" description="Creates a Pentaho-ready Tomcat instance.">
    <mkdir dir="${jre.dir}" />

    <ant antfile="assembly.xml" dir="../bi-platform-assembly">
      <target name="clean-all" />
      <target name="resolve" />
      <target name="assemble" />
    </ant>

    <!-- Remove pentaho-bi-platform-*.jar since we want to use classes instead. -->
    <delete>
      <fileset dir="${target.tomcat.dir}/webapps/pentaho/WEB-INF/lib">
        <include name="pentaho-bi-platform-*.jar" />
      </fileset>
    </delete>
    <antcall target="dev-update" />
    <!-- make the webapp reloadable (Tomcat will monitor classes for changes) -->
    <xmltask source="${target.tomcat.dir}/webapps/pentaho/META-INF/context.xml" 
      dest="${target.tomcat.dir}/webapps/pentaho/META-INF/context.xml">
      <attr path="/Context" attr="reloadable" value="true" />
    </xmltask>
    <!-- check context.xml for well-formedness -->
    <xmlvalidate file="${target.tomcat.dir}/webapps/pentaho/META-INF/context.xml" 
      failonerror="yes" lenient="yes" warn="yes" />
  </target>

  <target name="dev-update" description="Copies code and solution files.">
    <sequential>
      <ant antfile="build.xml" dir="../bi-platform-api" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-util" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-engine-core" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-engine-security" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-engine-services" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-repository" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-ui-foundation" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-plugin-services" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-plugin-actions" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-scheduler" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-legacy" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-web" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-web-servlet" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-web-portlet" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-security-userroledao" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-data-access" target="compile">
        <reference refid="classpath" />
      </ant>     	
    </sequential>
    <antcall target="copy-solution" />
  </target>

  <target name="help" description="Displays help information.">
    <echo level="info">Run 'ant -f dev_build.xml -projecthelp' for more information.</echo>
  </target>

  <target name="copy-solution" description="Copies Pentaho solution files.">
    <copy todir="${target-solution}">
      <fileset dir="${source-solution}" />
    </copy>
  </target>

  <target name="resolve" description="Performs the resolve task on all the platform projects">
    <ant antfile="build.xml" dir="../bi-platform-api" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-util" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-engine-core" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-engine-security" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-engine-services" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-repository" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-ui-foundation" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-plugin-services" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-plugin-actions" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-scheduler" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-legacy" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-web" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-web-servlet" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-web-portlet" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-security-userroledao" target="resolve" />
  	<ant antfile="build.xml" dir="../bi-platform-data-access" target="resolve" />
    <ant antfile="build.xml" dir="../mantle" target="resolve" />
  </target>

  <target name="clean-all" description="Performs the clean-all task on all the platform projects">
    <ant antfile="build.xml" dir="../bi-platform-api" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-util" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-engine-core" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-engine-security" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-engine-services" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-repository" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-ui-foundation" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-plugin-services" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-plugin-actions" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-scheduler" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-legacy" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-web" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-web-servlet" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-web-portlet" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-security-userroledao" target="clean-all" />
  	<ant antfile="build.xml" dir="../bi-platform-data-access" target="clean-all" />
    <ant antfile="build.xml" dir="../mantle" target="clean-all" />
  </target>

  <target name="clean-dist" description="Performs the clean-dist task on all the platform projects">
    <ant antfile="build.xml" dir="../bi-platform-api" target="clean-dist" />
    <ant antfile="build.xml" dir="../bi-platform-util" target="clean-dist" />
    <ant antfile="build.xml" dir="../bi-platform-engine-core" target="clean-dist" />
    <ant antfile="build.xml" dir="../bi-platform-engine-security" target="clean-dist" />
    <ant antfile="build.xml" dir="../bi-platform-engine-services" target="clean-dist" />
    <ant antfile="build.xml" dir="../bi-platform-repository" target="clean-dist" />
    <ant antfile="build.xml" dir="../bi-platform-ui-foundation" target="clean-dist" />
    <ant antfile="build.xml" dir="../bi-platform-plugin-services" target="clean-dist" />
    <ant antfile="build.xml" dir="../bi-platform-plugin-actions" target="clean-dist" />
    <ant antfile="build.xml" dir="../bi-platform-scheduler" target="clean-dist" />
    <ant antfile="build.xml" dir="../bi-platform-legacy" target="clean-dist" />
    <ant antfile="build.xml" dir="../bi-platform-web" target="clean-dist" />
    <ant antfile="build.xml" dir="../bi-platform-web-servlet" target="clean-dist" />
    <ant antfile="build.xml" dir="../bi-platform-web-portlet" target="clean-dist" />
    <ant antfile="build.xml" dir="../bi-platform-security-userroledao" target="clean-dist" />
  	<ant antfile="build.xml" dir="../bi-platform-data-access" target="clean-dist" />  	
    <ant antfile="build.xml" dir="../mantle" target="clean-dist" />
  </target>

  <target name="compile" description="Performs the compile task on all the platform projects">
    <ant antfile="build.xml" dir="../bi-platform-api" target="compile" />
    <ant antfile="build.xml" dir="../bi-platform-util" target="compile" />
    <ant antfile="build.xml" dir="../bi-platform-engine-core" target="compile" />
    <ant antfile="build.xml" dir="../bi-platform-engine-security" target="compile" />
    <ant antfile="build.xml" dir="../bi-platform-engine-services" target="compile" />
    <ant antfile="build.xml" dir="../bi-platform-repository" target="compile" />
    <ant antfile="build.xml" dir="../bi-platform-ui-foundation" target="compile" />
    <ant antfile="build.xml" dir="../bi-platform-plugin-services" target="compile" />
    <ant antfile="build.xml" dir="../bi-platform-plugin-actions" target="compile" />
    <ant antfile="build.xml" dir="../bi-platform-scheduler" target="compile" />
    <ant antfile="build.xml" dir="../bi-platform-legacy" target="compile" />
    <ant antfile="build.xml" dir="../bi-platform-web" target="compile" />
    <ant antfile="build.xml" dir="../bi-platform-web-servlet" target="compile" />
    <ant antfile="build.xml" dir="../bi-platform-web-portlet" target="compile" />
    <ant antfile="build.xml" dir="../bi-platform-security-userroledao" target="compile" />
  	<ant antfile="build.xml" dir="../bi-platform-data-access" target="compile" />
    <ant antfile="build.xml" dir="../mantle" target="compile" />
  </target>

  <target name="dist" description="Performs the dist task on all the platform projects">
    <ant antfile="build.xml" dir="../bi-platform-api" target="dist" />
    <ant antfile="build.xml" dir="../bi-platform-util" target="dist" />
    <ant antfile="build.xml" dir="../bi-platform-engine-core" target="dist" />
    <ant antfile="build.xml" dir="../bi-platform-engine-security" target="dist" />
    <ant antfile="build.xml" dir="../bi-platform-engine-services" target="dist" />
    <ant antfile="build.xml" dir="../bi-platform-repository" target="dist" />
    <ant antfile="build.xml" dir="../bi-platform-ui-foundation" target="dist" />
    <ant antfile="build.xml" dir="../bi-platform-plugin-services" target="dist" />
    <ant antfile="build.xml" dir="../bi-platform-plugin-actions" target="dist" />
    <ant antfile="build.xml" dir="../bi-platform-scheduler" target="dist" />
    <ant antfile="build.xml" dir="../bi-platform-legacy" target="dist" />
    <ant antfile="build.xml" dir="../bi-platform-web" target="dist" />
    <ant antfile="build.xml" dir="../bi-platform-web-servlet" target="dist" />
    <ant antfile="build.xml" dir="../bi-platform-web-portlet" target="dist" />
    <ant antfile="build.xml" dir="../bi-platform-security-userroledao" target="dist" />
  	<ant antfile="build.xml" dir="../bi-platform-data-access" target="dist" />
    <ant antfile="build.xml" dir="../mantle" target="dist" />
  </target>

  <target name="resolve-publish-local-all" description="">
    <delete dir="${user.home}/.ivy2/local/pentaho" />
    <ant antfile="build.xml" dir="../bi-platform-api">
      <target name="clean-all" />
        <target name="resolve" />
        <target name="publish-local" />
    </ant>
    <ant antfile="build.xml" dir="../bi-platform-util">
      <target name="clean-all" />
        <target name="resolve" />
        <target name="publish-local" />
    </ant>
    <ant antfile="build.xml" dir="../bi-platform-engine-core">
      <target name="clean-all" />
        <target name="resolve" />
        <target name="publish-local" />
    </ant>
    <ant antfile="build.xml" dir="../bi-platform-engine-security">
      <target name="clean-all" />
        <target name="resolve" />
        <target name="publish-local" />
    </ant>
    <ant antfile="build.xml" dir="../bi-platform-engine-services">
      <target name="clean-all" />
        <target name="resolve" />
        <target name="publish-local" />
    </ant>
    <ant antfile="build.xml" dir="../bi-platform-repository">
      <target name="clean-all" />
        <target name="resolve" />
        <target name="publish-local" />
    </ant>
    <ant antfile="build.xml" dir="../bi-platform-ui-foundation">
      <target name="clean-all" />
        <target name="resolve" />
        <target name="publish-local" />
    </ant>
    <ant antfile="build.xml" dir="../bi-platform-plugin-services">
      <target name="clean-all" />
        <target name="resolve" />
        <target name="publish-local" />
    </ant>
    <ant antfile="build.xml" dir="../bi-platform-plugin-actions">
      <target name="clean-all" />
        <target name="resolve" />
        <target name="publish-local" />
    </ant>
    <ant antfile="build.xml" dir="../bi-platform-scheduler">
      <target name="clean-all" />
        <target name="resolve" />
        <target name="publish-local" />
    </ant>
    <ant antfile="build.xml" dir="../bi-platform-legacy">
      <target name="clean-all" />
        <target name="resolve" />
        <target name="publish-local" />
    </ant>
    <ant antfile="build.xml" dir="../bi-platform-web">
      <target name="clean-all" />
        <target name="resolve" />
        <target name="publish-local" />
    </ant>
    <ant antfile="build.xml" dir="../bi-platform-web-servlet">
      <target name="clean-all" />
        <target name="resolve" />
        <target name="publish-local" />
    </ant>
    <ant antfile="build.xml" dir="../bi-platform-web-portlet">
      <target name="clean-all" />
        <target name="resolve" />
        <target name="publish-local" />
    </ant>
    <ant antfile="build.xml" dir="../bi-platform-security-userroledao">
      <target name="clean-all" />
        <target name="resolve" />
        <target name="publish-local" />
    </ant>
    <ant antfile="build.xml" dir="../bi-platform-data-access">
      <target name="clean-all" />
        <target name="resolve" />
        <target name="publish-local" />
    </ant>  	
    <ant antfile="build.xml" dir="../pentaho-open-admin-console">
      <target name="clean-all" />
        <target name="resolve" />
        <target name="publish-local" />
    </ant>
  </target>
  
</project>