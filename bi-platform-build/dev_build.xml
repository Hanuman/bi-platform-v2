<!-- 
  Development build script for Pentaho BI Platform.
  
  Assumptions:
    * bi-platform-* projects are checked out from Subversion in the same directory (e.g. basedir).
    * You are developing using Apache Tomcat.
-->
<project name="bi-platform-dev" basedir="." default="dev-update">

  <property file="dev_override.properties" />
  <property file="dev_build.properties" />
  
  <condition property="is-hsqldb">
    <equals arg1="${database-type}" arg2="hsqldb" />
  </condition>

  <target name="clean" description="create distribution">
    <delete dir="${target-solution}" />
    <delete dir="${target-data}" />
    <delete dir="${target-tomcat}" />
  </target>

  <target name="copy-solution">
    <copy todir="${target-solution}">
      <fileset dir="${source-solution}" />
    </copy>
  </target>
  
  <target name="copy-tomcat">
    <copy todir="${target-tomcat-dir}">
      <fileset dir="${source-tomcat-dir}" />
    </copy>
  </target>

  <target name="copy-webapp-stuff">
    <copy todir="${target-pentaho-war}">
      <fileset dir="${platform-webapp}" />
    </copy>
    <copy todir="${target-sw-style-war}">
      <fileset dir="${sw-style-webapp}" />
    </copy>
    <copy todir="${target-pentaho-style-war}">
      <fileset dir="${pentaho-style-webapp}" />
    </copy>
  </target>

  <target name="copy-jars">
    <copy todir="${target-pentaho-war}/WEB-INF/lib">
      <fileset dir="." includes="pentaho-bi-platform-*.jar" />
    </copy>
    <copy todir="${target-pentaho-war}/WEB-INF/lib">
      <fileset dir="all-libs">
        <patternset id="non.test.sources">
          <exclude name="**/servlet-api.jar" />
          <exclude name="**/log4j-1.2.9.jar" />
          <exclude name="**/junit*.jar" />
          <exclude name="**/xalan-2.4.1.jar" />
          <exclude name="**/xercesImpl-2.6.2.jar" />
          <exclude name="**/xml-apis-1.0.b2.jar" />
          <exclude name="**/xml-apis-1.3.02.jar" />
          <exclude name="**/xom-1.0.jar" />
          <exclude name="**/commons-collections-3.1.jar" />
          <exclude name="**/icu4j-2.6.1.jar" />
          <exclude name="**/jaxen-1.1-beta-6.jar" />
          <exclude name="**/commons-digester-1.7.jar" />
        </patternset>
      </fileset>
      <fileset dir="${bi-platform-assembly-open-dir}/lib">
        <include name="**/*.jar" />
        <exclude name="**/portal-security-lib.jar" />
        <exclude name="**/portal-portlet-lib.jar" />
        <exclude name="**/portal-core-lib.jar" />
        <exclude name="**/quartz-oracle-1.5.2.jar" />
        <exclude name="**/pentaho-bi-*.jar" />
        <exclude name="**/servlet-api.jar" />
        <exclude name="**/excludejars.jboss" />
        <exclude name="**/excludejars.generic" />
      </fileset>
    </copy>

    <copy todir="${target-pentaho-war}/WEB-INF/lib">
      <fileset dir="all-libs" excludes="**/servlet-api.jar" />
    </copy>
  </target>

  <target name="dev-update" depends="jar-all, copy-tomcat, copy-data, copy-jars, copy-webapp-stuff, copy-solution, copy-datasource-stuff">
    <echo message="Updated" />
  </target>

  <target name="dev-rebuild" depends="clean-all, resolve, dev-update">
    <echo message="Updated" />
  </target>

  <target name="clean-all" depends="clean">
    <ant antfile="build.xml" dir="../bi-platform-api" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-util" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-engine-core" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-test-foundation" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-engine-security" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-engine-services" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-repository" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-ui-foundation" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-plugin-services" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-plugin-actions" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-scheduler" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-legacy" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-web" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-web-servlet" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-web-portlet" target="clean-all" />
    <ant antfile="build.xml" dir="../bi-platform-appserver" target="clean-all" />
  </target>

  <target name="jar-all" depends="">
    <mkdir dir="all-libs" />

    <ant antfile="build.xml" dir="../bi-platform-api" target="dist" />
    <copy todir=".">
      <fileset dir="../bi-platform-api/dist" />
    </copy>
    <copy todir="./all-libs">
      <fileset dir="../bi-platform-api/lib" excludes="pentaho-bi-platform-*.jar" />
    </copy>

    <ant antfile="build.xml" dir="../bi-platform-util" target="dist" />
    <copy todir=".">
      <fileset dir="../bi-platform-util/dist" />
    </copy>
    <copy todir="./all-libs">
      <fileset dir="../bi-platform-util/lib" excludes="pentaho-bi-platform-*.jar" />
    </copy>

    <ant antfile="build.xml" dir="../bi-platform-engine-core" target="dist" />
    <copy todir=".">
      <fileset dir="../bi-platform-engine-core/dist" />
    </copy>
    <copy todir="./all-libs">
      <fileset dir="../bi-platform-engine-core/lib" excludes="pentaho-bi-platform-*.jar" />
    </copy>

    <ant antfile="build.xml" dir="../bi-platform-engine-security" target="dist" />
    <copy todir=".">
      <fileset dir="../bi-platform-engine-security/dist" />
    </copy>
    <copy todir="./all-libs">
      <fileset dir="../bi-platform-engine-security/lib" excludes="pentaho-bi-platform-*.jar" />
    </copy>

    <ant antfile="build.xml" dir="../bi-platform-engine-services" target="dist" />
    <copy todir=".">
      <fileset dir="../bi-platform-engine-services/dist" />
    </copy>
    <copy todir="./all-libs">
      <fileset dir="../bi-platform-engine-services/lib" excludes="pentaho-bi-platform-*.jar" />
    </copy>

    <ant antfile="build.xml" dir="../bi-platform-repository" target="dist" />
    <copy todir=".">
      <fileset dir="../bi-platform-repository/dist" />
    </copy>
    <copy todir="./all-libs">
      <fileset dir="../bi-platform-repository/lib" excludes="pentaho-bi-platform-*.jar" />
    </copy>

    <ant antfile="build.xml" dir="../bi-platform-ui-foundation" target="dist" />
    <copy todir=".">
      <fileset dir="../bi-platform-ui-foundation/dist" />
    </copy>
    <copy todir="./all-libs">
      <fileset dir="../bi-platform-ui-foundation/lib" excludes="pentaho-bi-platform-*.jar" />
    </copy>

    <ant antfile="build.xml" dir="../bi-platform-plugin-services" target="dist" />
    <copy todir=".">
      <fileset dir="../bi-platform-plugin-services/dist" />
    </copy>
    <copy todir="./all-libs">
      <fileset dir="../bi-platform-plugin-services/lib" excludes="pentaho-bi-platform-*.jar" />
    </copy>

    <ant antfile="build.xml" dir="../bi-platform-plugin-actions" target="dist" />
    <copy todir=".">
      <fileset dir="../bi-platform-plugin-actions/dist" />
    </copy>
    <copy todir="./all-libs">
      <fileset dir="../bi-platform-plugin-actions/lib" excludes="pentaho-bi-platform-*.jar" />
    </copy>

    <ant antfile="build.xml" dir="../bi-platform-scheduler" target="dist" />
    <copy todir=".">
      <fileset dir="../bi-platform-scheduler/dist" />
    </copy>
    <copy todir="./all-libs">
      <fileset dir="../bi-platform-scheduler/lib" excludes="pentaho-bi-platform-*.jar" />
    </copy>

    <ant antfile="build.xml" dir="../bi-platform-legacy" target="dist" />
    <copy todir=".">
      <fileset dir="../bi-platform-legacy/dist" />
    </copy>
    <copy todir="./all-libs">
      <fileset dir="../bi-platform-legacy/lib" excludes="pentaho-bi-platform-*.jar" />
    </copy>

    <ant antfile="build.xml" dir="../bi-platform-web" target="dist" />
    <copy todir=".">
      <fileset dir="../bi-platform-web/dist" />
    </copy>
    <copy todir="./all-libs">
      <fileset dir="../bi-platform-web/lib" excludes="pentaho-bi-platform-*.jar" />
    </copy>

    <ant antfile="build.xml" dir="../bi-platform-web-servlet" target="dist" />
    <copy todir=".">
      <fileset dir="../bi-platform-web-servlet/dist" />
    </copy>
    <copy todir="./all-libs">
      <fileset dir="../bi-platform-web-servlet/lib" excludes="pentaho-bi-platform-*.jar" />
    </copy>

    <ant antfile="build.xml" dir="../bi-platform-web-portlet" target="dist" />
    <copy todir=".">
      <fileset dir="../bi-platform-web-portlet/dist" />
    </copy>
    <copy todir="./all-libs">
      <fileset dir="../bi-platform-web-portlet/lib" excludes="pentaho-bi-platform-*.jar" />
    </copy>

    <!-- Remove the servlet-api jar -->
    <delete>
      <fileset dir="./all-libs" includes="servlet-api-*.jar" />
    </delete>
  </target>

  <target name="resolve">
    <ant antfile="build.xml" dir="../bi-platform-api" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-util" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-engine-core" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-test-foundation" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-engine-security" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-engine-services" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-repository" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-ui-foundation" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-plugin-services" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-plugin-actions" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-scheduler" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-legacy" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-web" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-web-servlet" target="resolve" />
    <ant antfile="build.xml" dir="../bi-platform-web-portlet" target="resolve" />
  </target>

  <target name="create-dot-classpaths">
    <ant antfile="build.xml" dir="../bi-platform-api" target="create-dot-classpath" />
    <ant antfile="build.xml" dir="../bi-platform-util" target="create-dot-classpath" />
    <ant antfile="build.xml" dir="../bi-platform-engine-core" target="create-dot-classpath" />
    <ant antfile="build.xml" dir="../bi-platform-test-foundation" target="create-dot-classpath" />
    <ant antfile="build.xml" dir="../bi-platform-engine-security" target="create-dot-classpath" />
    <ant antfile="build.xml" dir="../bi-platform-engine-services" target="create-dot-classpath" />
    <ant antfile="build.xml" dir="../bi-platform-repository" target="create-dot-classpath" />
    <ant antfile="build.xml" dir="../bi-platform-ui-foundation" target="create-dot-classpath" />
    <ant antfile="build.xml" dir="../bi-platform-plugin-services" target="create-dot-classpath" />
    <ant antfile="build.xml" dir="../bi-platform-plugin-actions" target="create-dot-classpath" />
    <ant antfile="build.xml" dir="../bi-platform-scheduler" target="create-dot-classpath" />
    <ant antfile="build.xml" dir="../bi-platform-legacy" target="create-dot-classpath" />
    <ant antfile="build.xml" dir="../bi-platform-web" target="create-dot-classpath" />
    <ant antfile="build.xml" dir="../bi-platform-web-servlet" target="create-dot-classpath" />
    <ant antfile="build.xml" dir="../bi-platform-web-portlet" target="create-dot-classpath" />
    <ant antfile="build.xml" dir="../bi-platform-appserver" target="create-dot-classpath" />
  </target>

  <target name="copy-data" if="is-hsqldb" description="Copies HSQLDB sample data.">
    <copy todir="${target-data}">
      <fileset dir="${source-data}">
        <include name="hibernate/**" />  
        <include name="quartz/**" />
        <include name="sampledata/**" />
        <include name="*_hypersonic.*" />
      </fileset>
    </copy>
    <mkdir dir="${target-data}/lib" />
    <copy todir="${target-data}/lib" file="${jdbc-jar-path}" />
  </target>
  
  <target name="copy-datasource-stuff">
    <copy todir="${target-tomcat-lib-dir}" file="${jdbc-jar-path}" />
    <mkdir dir="${platform-webapp}/META-INF" />
    <copy todir="${platform-webapp}/META-INF" file="${context-xml-dir}/context.xml" />
  </target>

</project>