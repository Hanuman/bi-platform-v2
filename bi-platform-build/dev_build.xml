<project name="bi-platform-dev" basedir="." default="help">

  <description>
-------------------------------------------------------------------------------
Development build script for Pentaho BI Platform.
      
TARGETS
=======
    
  * dev-rebuild: Prepares a clean Tomcat instance with all Pentaho BI Platform 
    dependencies (i.e. JDBC JAR, datasources, supporting WARs, etc), also known
    as a Pentaho-ready Tomcat.
    
  * dev-update:    
    Copy changed artifacts into Tomcat instance.
      
ASSUMPTIONS
===========
    
  * bi-platform-* projects are checked out from Subversion in the same 
    directory (e.g. basedir).
  * You are developing using Apache Tomcat.
-------------------------------------------------------------------------------
  </description>

  <property file="dev_override.properties" />
  <property file="dev_build.properties" />

  <path id="classpath">
    <!-- classes dir is both a destination for .class files and a source for dependencies -->
    <dirset dir="${classes.dir}" />
    <!-- WEB-INF/lib contains non-bi-platform-* dependencies (populated by dev_rebuild) -->
    <fileset dir="${web-inf.lib.dir}">
      <include name="*.jar" />
    </fileset>
    <!-- need this for servlet.jar -->
    <fileset dir="${tomcat.lib.dir}">
      <include name="*.jar" />
    </fileset>
  </path>

  <target name="dev-rebuild" description="Creates a Pentaho-ready Tomcat instance.">
    <mkdir dir="${jre.dir}" />
    
    <ant antfile="assembly.xml" dir="../bi-platform-assembly-open">
      <target name="clean-all" />
      <target name="resolve" />
      <target name="assemble" />
    </ant>
    
    <!-- Remove pentaho-bi-platform-*.jar since we want to use classes instead. -->
    <delete>
      <fileset dir="${target.tomcat.dir}/webapps/pentaho/WEB-INF/lib">
        <include name="pentaho-bi-platform-*.jar" />
      </fileset>
    </delete>
    <antcall target="dev-update" />
  </target>

  <target name="dev-update" description="Copies code and solution files.">
    <sequential>
      <ant antfile="build.xml" dir="../bi-platform-api" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-util" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-engine-core" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-engine-security" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-engine-services" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-repository" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-ui-foundation" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-plugin-services" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-plugin-actions" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-scheduler" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-legacy" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-web" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-web-servlet" target="compile">
        <reference refid="classpath" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-web-portlet" target="compile">
        <reference refid="classpath" />
      </ant>
    </sequential>
  </target>
  
  <target name="help" description="Displays help information.">
    <echo level="info">Run 'ant -f dev_build.xml -projecthelp' for more information.</echo>
  </target>
  
  <target name="copy-solution" description="Copies Pentaho solution files.">
    <copy todir="${target-solution}">
      <fileset dir="${source-solution}" />
    </copy>
  </target>

</project>